(()=>{"use strict";var t={197:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StreamSplitter=e.splitNewLines=void 0;const s=r(203);e.splitNewLines=()=>new o("\n".charCodeAt(0));class o extends s.Transform{splitter;buffer;constructor(t){super(),this.splitter=t}_transform(t,e,r){this.buffer?this.buffer=Buffer.concat([this.buffer,t]):this.buffer=t;let s=0;for(;s<this.buffer.length;){const t=this.buffer.indexOf(this.splitter,s);if(-1===t)break;this.push(this.buffer.subarray(s,t)),s=t+1}this.buffer=s===this.buffer.length?void 0:this.buffer.subarray(s),r()}_flush(t){this.buffer&&this.push(this.buffer),t()}}e.StreamSplitter=o},203:t=>{t.exports=require("stream")},256:function(t,e,r){var s,o=this&&this.__createBinding||(Object.create?function(t,e,r,s){void 0===s&&(s=r);var o=Object.getOwnPropertyDescriptor(e,r);o&&!("get"in o?!e.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,o)}:function(t,e,r,s){void 0===s&&(s=r),t[s]=e[r]}),i=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),n=this&&this.__importStar||(s=function(t){return s=Object.getOwnPropertyNames||function(t){var e=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[e.length]=r);return e},s(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r=s(t),n=0;n<r.length;n++)"default"!==r[n]&&o(e,t,r[n]);return i(e,t),e});Object.defineProperty(e,"__esModule",{value:!0}),e.activate=async function(t){if(u.env.remoteAuthority)return;const e=new g(u.l10n.t("Port Forwarding")),r=new m(e,t);t.subscriptions.push(u.commands.registerCommand("tunnel-forwarding.showLog",()=>e.show()),u.commands.registerCommand("tunnel-forwarding.restart",()=>r.restart()),r.onDidStateChange(t=>{u.commands.executeCommand("setContext","tunnelForwardingIsRunning",2!==t.state)}),await u.workspace.registerTunnelProvider(r,{tunnelFeatures:{elevation:!1,protocol:!0,privacyOptions:[{themeIcon:"globe",id:"public",label:u.l10n.t("Public")},{themeIcon:"lock",id:"private",label:u.l10n.t("Private")}]}}))},e.deactivate=function(){};const a=r(317),c=n(r(928)),u=n(r(398)),l=r(653),h=r(197),p=process.env.VSCODE_FORWARDING_IS_DEV?c.join(__dirname,"../../../cli/target/debug/code"):c.join(u.env.appRoot,"darwin"===process.platform?"bin":"../../bin","stable"===u.env.appQuality?"code-tunnel":"code-tunnel-insiders")+("win32"===process.platform?".exe":"");class d{remoteAddress;privacy;protocol;disposeEmitter=new u.EventEmitter;onDidDispose=this.disposeEmitter.event;localAddress;constructor(t,e,r){this.remoteAddress=t,this.privacy=e,this.protocol=r}setPortFormat(t){this.localAddress=t.replace("{port}",String(this.remoteAddress.port))}dispose(){this.disposeEmitter.fire()}}class g{label;outputChannel;constructor(t){this.label=t}show(){return this.outputChannel?.show()}clear(){this.outputChannel?.clear()}log(t,e,...r){this.outputChannel||(this.outputChannel=u.window.createOutputChannel(this.label,{log:!0}),u.commands.executeCommand("setContext","tunnelForwardingHasLog",!0)),this.outputChannel[t](e,...r)}}const f="didWarnPublic";class m{logger;context;tunnels=new Set;stateChange=new u.EventEmitter;_state={state:2};get state(){return this._state}set state(t){this._state=t,this.stateChange.fire(t)}onDidStateChange=this.stateChange.event;constructor(t,e){this.logger=t,this.context=e}async provideTunnel(t){if("public"===t.privacy&&!await this.consentPublicPort(t.remoteAddress.port))return;const e=new d(t.remoteAddress,t.privacy||"private","https"===t.protocol?"https":"http");switch(this.tunnels.add(e),e.onDidDispose(()=>{this.tunnels.delete(e),this.updateActivePortsIfRunning()}),this.state.state){case 3:case 2:await this.setupPortForwardingProcess();case 0:return this.updateActivePortsIfRunning(),new Promise((t,r)=>{const s=this.stateChange.event(o=>{1===o.state?(e.setPortFormat(o.portFormat),s.dispose(),t(e)):3===o.state&&(s.dispose(),r(new Error(o.error)))})});case 1:return e.setPortFormat(this.state.portFormat),this.updateActivePortsIfRunning(),e}}async restart(){this.killRunningProcess(),await this.setupPortForwardingProcess(),this.updateActivePortsIfRunning()}async consentPublicPort(t){if(this.context.globalState.get(f,!1))return!0;const e=u.l10n.t("Continue"),r=u.l10n.t("Don't show again"),s=await u.window.showWarningMessage(u.l10n.t("You're about to create a publicly forwarded port. Anyone on the internet will be able to connect to the service listening on port {0}. You should only proceed if this service is secure and non-sensitive.",t),{modal:!0},e,r);if(s===e);else{if(s!==r)return!1;await this.context.globalState.update(f,!0)}return!0}isInStateWithProcess(t){return(0===this.state.state||1===this.state.state)&&this.state.process===t}killRunningProcess(){0!==this.state.state&&1!==this.state.state||(this.logger.log("info","[forwarding] no more ports, stopping forwarding CLI"),this.state.process.kill(),this.state={state:2})}updateActivePortsIfRunning(){if(0!==this.state.state&&1!==this.state.state)return;const t=[...this.tunnels].map(t=>({number:t.remoteAddress.port,privacy:t.privacy,protocol:t.protocol}));this.state.process.stdin.write(`${JSON.stringify(t)}\n`),0!==t.length||this.state.cleanupTimeout?t.length>0&&this.state.cleanupTimeout&&(clearTimeout(this.state.cleanupTimeout),this.state.cleanupTimeout=void 0):this.state.cleanupTimeout=setTimeout(()=>this.killRunningProcess(),1e4)}async setupPortForwardingProcess(){const t=await u.authentication.getSession("github",["user:email","read:org"],{createIfNone:!0});this.logger.log("info","[forwarding] starting CLI");const e=(0,a.spawn)(p,["--verbose","tunnel","forward-internal","--provider","github"],{stdio:"pipe",env:{...process.env,NO_COLOR:"1",VSCODE_CLI_ACCESS_TOKEN:t.accessToken}});this.state={state:0,process:e};const r=new l.DeferredPromise;u.window.withProgress({location:u.ProgressLocation.Notification,title:u.l10n.t({comment:['do not change link format [Show Log](command), only change the text "Show Log"'],message:"Starting port forwarding system ([Show Log]({0}))",args:["command:tunnel-forwarding.showLog"]})},()=>r.p),e.on("exit",t=>{const s=`[forwarding] exited with code ${t}`;this.logger.log("info",s),r.complete(),this.isInStateWithProcess(e)&&(this.state={state:3,error:s})}),e.on("error",t=>{this.logger.log("error",`[forwarding] ${t}`),r.complete(),this.isInStateWithProcess(e)&&(this.state={state:3,error:String(t)})}),e.stdout.pipe((0,h.splitNewLines)()).on("data",t=>this.logger.log("info",`[forwarding] ${t}`)).resume(),e.stderr.pipe((0,h.splitNewLines)()).on("data",t=>{try{const s=JSON.parse(t);s.port_format&&void 0!==s.port_format&&(this.state={state:1,portFormat:s.port_format,process:e,cleanupTimeout:"cleanupTimeout"in this.state?this.state.cleanupTimeout:void 0},r.complete())}catch(e){this.logger.log("error",`[forwarding] ${t}`)}}).resume(),await new Promise((t,r)=>{e.on("spawn",t),e.on("error",r)})}}},317:t=>{t.exports=require("child_process")},398:t=>{t.exports=require("vscode")},653:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.DeferredPromise=void 0,e.DeferredPromise=class{completeCallback;errorCallback;outcome;get isRejected(){return 1===this.outcome?.outcome}get isResolved(){return 0===this.outcome?.outcome}get isSettled(){return!!this.outcome}get value(){return 0===this.outcome?.outcome?this.outcome?.value:void 0}p;constructor(){this.p=new Promise((t,e)=>{this.completeCallback=t,this.errorCallback=e})}complete(t){return new Promise(e=>{this.completeCallback(t),this.outcome={outcome:0,value:t},e()})}error(t){return new Promise(e=>{this.errorCallback(t),this.outcome={outcome:1,value:t},e()})}}},928:t=>{t.exports=require("path")}},e={},r=function r(s){var o=e[s];if(void 0!==o)return o.exports;var i=e[s]={exports:{}};return t[s].call(i.exports,i,i.exports,r),i.exports}(256),s=exports;for(var o in r)s[o]=r[o];r.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})})();
//# sourceMappingURL=https://main.vscode-cdn.net/sourcemaps/03c265b1adee71ac88f833e065f7bb956b60550a/extensions/tunnel-forwarding/dist/extension.js.map